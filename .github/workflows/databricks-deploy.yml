name: Deploy Databricks Job with DABS

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      databricks_host:
        description: 'Databricks Workspace URL (e.g., https://dbc-xxxxx.cloud.databricks.com)'
        required: true
        type: string
        default: 'https://dbc-0bff3115-71d9.cloud.databricks.com/'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: 'dev'
      warehouse_id:
        description: 'SQL Warehouse ID (optional, uses default if not provided)'
        required: false
        type: string
        default: 'ec354449db0ae20a'

  # Automatic trigger on push to main branch
  push:
    branches:
      - main
    paths:
      - 'notebooks/**'
      - 'resources/**'
      - 'databricks.yml'
      - '.github/workflows/databricks-deploy.yml'

jobs:
  deploy:
    name: Deploy to Databricks
    runs-on: ubuntu-latest
    
    # Required for OIDC token
    permissions:
      id-token: write
      contents: read
    
    env:
      DATABRICKS_AUTH_TYPE: github-oidc
      DATABRICKS_HOST: https://dbc-0bff3115-71d9.cloud.databricks.com/
      DATABRICKS_CLIENT_ID: 0fb7894e-ecb6-4ab6-b5ab-2b1e09397949
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
          databricks --version
      
      - name: Deploy DABS Bundle
        run: |
          # Set the target environment
          TARGET="${{ inputs.environment}}"
          
          # Set variables
          export TF_VAR_databricks_host="${{ inputs.databricks_host }}"
          export TF_VAR_warehouse_id="${{ inputs.warehouse_id }}"
          
          # Validate the bundle
          databricks bundle validate -t $TARGET
          
          # Deploy the bundle
          databricks bundle deploy -t $TARGET
      
      - name: Run Job (if enabled)
        id: run_job
        run: |
          TARGET="${{ inputs.environment || 'dev' }}"
          
          echo "Running the deployed job..."
          
          # Run the job and capture the run ID
          RUN_OUTPUT=$(databricks bundle run market_analysis -t $TARGET)
          echo "$RUN_OUTPUT"
          
          # Extract run ID (adjust based on actual output format)
          RUN_ID=$(echo "$RUN_OUTPUT" | grep -oP 'Run ID: \K\d+' || echo "unknown")
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          echo "Job triggered with Run ID: $RUN_ID"
      

